<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tudor - To do it or not</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/components.css" />
  </head>
  <body>
    <!-- Toggle Indicators -->
    <!-- <div
      class="header-toggle-indicator"
      id="headerToggleIndicator"
      style="display: none"
      onclick="toggleHeader()"
    >
      Show Header
    </div>
    <div
      class="legend-toggle-indicator"
      id="legendToggleIndicator"
      style="display: none"
      onclick="toggleLegend()"
    >
      Show Legend
    </div> -->

    <!-- Header -->
    <div class="header" id="header">
      <h1>Big A## Calendar <span id="currentYearDisplay">2026</span></h1>
      <p>Plan Your Life Before Your Meetings</p>
      <div style="margin-top: 15px">
        <label style="font-weight: bold; margin-right: 10px">Year:</label>
        <select
          id="yearSelector"
          style="
            padding: 8px 15px;
            font-size: 16px;
            border-radius: 6px;
            border: none;
          "
          onchange="changeYear(this.value)"
        >
          <option value="2025">2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
          <option value="2028">2028</option>
          <option value="2029">2029</option>
          <option value="2030">2030</option>
        </select>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls" id="controls">
      <button class="toggle-btn" onclick="toggleHeader()">
        <span id="headerToggleIcon">ðŸ“‰</span> Header
      </button>
      <button class="toggle-btn" onclick="toggleLegend()">
        <span id="legendToggleIcon">ðŸ“‰</span> Legend
      </button>
      <button class="btn-primary" onclick="clearAllActivities()">
        Clear All
      </button>
      <button class="btn-success" onclick="exportAsImage()">
        Save as Image
      </button>
      <button class="btn-warning" onclick="exportAsPDF()">Save as PDF</button>
      <button class="btn-danger" onclick="resetColorLabels()">
        Reset Labels
      </button>
    </div>

    <!-- Legend -->
    <div class="legend" id="legend">
      <h3>Color Legend (Click to Edit)</h3>
      <div class="legend-items" id="legendItems"></div>
    </div>

    <!-- Calendar -->
    <div class="year-view" id="calendar"></div>

    <!-- Month Detail Overlay -->
    <div class="month-detail-overlay" id="monthDetailOverlay">
      <div class="month-detail">
        <div class="month-detail-header">
          <h2 id="detailMonthTitle"></h2>
          <button class="close-detail" onclick="closeMonthDetail()">
            âœ• Close
          </button>
        </div>
        <div class="month-detail-grid" id="monthDetailGrid"></div>
      </div>
    </div>

    <!-- Activity Modal -->
    <div class="modal" id="activityModal">
      <div class="modal-content">
        <h3 id="modalTitle">Add Activity</h3>
        <div class="form-group">
          <label>Date:</label>
          <input type="text" id="activityDate" readonly />
        </div>
        <div class="form-group">
          <label>Activity:</label>
          <input
            type="text"
            id="activityText"
            placeholder="What are you doing?"
          />
        </div>
        <div class="form-group">
          <label>Category:</label>
          <div class="color-picker" id="colorPicker"></div>
          <input type="hidden" id="selectedColor" value="#3498db" />
        </div>
        <div id="activityList"></div>
        <div class="modal-buttons">
          <button class="btn-primary" onclick="saveActivity()">Save</button>
          <button class="btn-warning" onclick="closeModal()">Cancel</button>
        </div>
      </div>
    </div>

    <div class="quick-add" id="quickAdd"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/calendar.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
    <script>
      const months = [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December",
      ];
      const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

      const defaultColors = [
        { color: "#3498db", label: "Family" },
        { color: "#e74c3c", label: "Fitness" },
        { color: "#2ecc71", label: "Work" },
        { color: "#f39c12", label: "Travel" },
        { color: "#9b59b6", label: "Personal" },
        { color: "#1abc9c", label: "Goals" },
      ];

      let activities =
        JSON.parse(localStorage.getItem("bigAssCalendarActivities")) || {};
      let colorLabels = JSON.parse(
        localStorage.getItem("bigAssCalendarColorLabels")
      ) || [...defaultColors];
      let currentEditingDate = null;
      let currentDetailMonth = null;

      // NEW: Dynamic year variable
      let currentYear =
        parseInt(localStorage.getItem("bigAssCalendarYear")) || 2025;

      // NEW: Load year-specific activities
      function loadYearData() {
        const yearKey = `bigAssCalendarActivities_${currentYear}`;
        activities = JSON.parse(localStorage.getItem(yearKey)) || {};
      }

      // NEW: Save year-specific activities
      function saveYearData() {
        const yearKey = `bigAssCalendarActivities_${currentYear}`;
        localStorage.setItem(yearKey, JSON.stringify(activities));
      }

      // NEW: Change year function
      function changeYear(newYear) {
        currentYear = parseInt(newYear);
        localStorage.setItem("bigAssCalendarYear", currentYear);
        document.getElementById("currentYearDisplay").textContent = currentYear;
        loadYearData();
        generateCalendar();
      }

      // Check on this
      let headerHidden =
        localStorage.getItem("bigAssCalendarHeaderHidden") === "true";
      let legendHidden =
        localStorage.getItem("bigAssCalendarLegendHidden") === "true";

      function generateCalendar() {
        const container = document.getElementById("calendar");
        container.innerHTML = "";

        months.forEach((month, monthIndex) => {
          const monthDiv = document.createElement("div");
          monthDiv.className = "month";

          const header = document.createElement("div");
          header.className = "month-header";
          const monthActivityCount = countMonthActivities(monthIndex);
          header.innerHTML = `
                    <h2>${month}</h2>
                    <div class="activity-count">${monthActivityCount} activities</div>
                `;
          header.onclick = () => openMonthDetail(monthIndex);

          const daysGrid = document.createElement("div");
          daysGrid.className = "days-grid";

          daysOfWeek.forEach((day) => {
            const header = document.createElement("div");
            header.className = "day-header";
            header.textContent = day;
            daysGrid.appendChild(header);
          });

          // NEW: Dynamic date calculations
          const firstDay = new Date(currentYear, monthIndex, 1).getDay();
          const daysInMonth = new Date(
            currentYear,
            monthIndex + 1,
            0
          ).getDate();

          for (let i = 0; i < firstDay; i++) {
            daysGrid.appendChild(createDayElement(null, monthIndex));
          }

          for (let day = 1; day <= daysInMonth; day++) {
            daysGrid.appendChild(createDayElement(day, monthIndex));
          }

          monthDiv.appendChild(header);
          monthDiv.appendChild(daysGrid);
          container.appendChild(monthDiv);
        });
      }

      function createDayElement(day, monthIndex) {
        const dayDiv = document.createElement("div");
        dayDiv.className = "day";

        if (day === null) {
          dayDiv.classList.add("empty");
          return dayDiv;
        }

        const dateKey = `${currentYear}-${(monthIndex + 1)
          .toString()
          .padStart(2, "0")}-${day.toString().padStart(2, "0")}`;
        dayDiv.dataset.date = dateKey;

        const dayNumber = document.createElement("div");
        dayNumber.className = "day-number";
        dayNumber.textContent = day;
        dayDiv.appendChild(dayNumber);

        const dayContent = document.createElement("div");
        dayContent.className = "day-content";

        if (activities[dateKey]) {
          dayDiv.classList.add("activity");

          if (activities[dateKey].length >= 3) dayDiv.classList.add("busy-3");
          else if (activities[dateKey].length >= 2)
            dayDiv.classList.add("busy-2");
          else if (activities[dateKey].length >= 1)
            dayDiv.classList.add("busy-1");

          activities[dateKey].slice(0, 2).forEach((activity) => {
            const chip = document.createElement("div");
            chip.className = "activity-chip";
            chip.style.background = activity.color;
            chip.textContent =
              activity.text.length > 12
                ? activity.text.substring(0, 12) + "..."
                : activity.text;
            dayContent.appendChild(chip);
          });

          if (activities[dateKey].length > 2) {
            const badge = document.createElement("div");
            badge.className = "activity-chip badge";
            badge.style.background = "#2c3e50";
            badge.textContent = `+${activities[dateKey].length - 2}`;
            dayDiv.appendChild(badge);
          }
        }

        dayDiv.appendChild(dayContent);

        dayDiv.onmouseenter = (e) => showQuickAdd(e, dateKey);
        dayDiv.onmouseleave = hideQuickAdd;
        dayDiv.onclick = (e) => {
          if (!e.target.classList.contains("activity-chip")) {
            openModal(dateKey);
          }
        };

        return dayDiv;
      }

      function countMonthActivities(monthIndex) {
        let count = 0;
        const daysInMonth = new Date(currentYear, monthIndex + 1, 0).getDate();
        for (let day = 1; day <= daysInMonth; day++) {
          const dateKey = `${currentYear}-${(monthIndex + 1)
            .toString()
            .padStart(2, "0")}-${day.toString().padStart(2, "0")}`;
          if (activities[dateKey]) count += activities[dateKey].length;
        }
        return count;
      }

      function toggleHeader() {
        const header = document.getElementById("header");
        const controls = document.getElementById("controls");
        const indicator = document.getElementById("headerToggleIndicator");
        const icon = document.getElementById("headerToggleIcon");

        headerHidden = !headerHidden;
        localStorage.setItem("bigAssCalendarHeaderHidden", headerHidden);

        if (headerHidden) {
          header.classList.add("hidden");
          controls.classList.add("compact");
          indicator.style.display = "block";
          icon.textContent = "ðŸ“ˆ";
        } else {
          header.classList.remove("hidden");
          controls.classList.remove("compact");
          indicator.style.display = "none";
          icon.textContent = "ðŸ“‰";
        }
      }

      function toggleLegend() {
        const legend = document.getElementById("legend");
        const indicator = document.getElementById("legendToggleIndicator");
        const icon = document.getElementById("legendToggleIcon");

        legendHidden = !legendHidden;
        localStorage.setItem("bigAssCalendarLegendHidden", legendHidden);

        if (legendHidden) {
          legend.classList.add("hidden");
          indicator.style.display = "block";
          icon.textContent = "ðŸ“ˆ";
        } else {
          legend.classList.remove("hidden");
          indicator.style.display = "none";
          icon.textContent = "ðŸ“‰";
        }
      }

      function applySavedStates() {
        if (headerHidden) {
          toggleHeader();
        }
        if (legendHidden) {
          toggleLegend();
        }
      }

      function openMonthDetail(monthIndex) {
        currentDetailMonth = monthIndex;
        const overlay = document.getElementById("monthDetailOverlay");
        const title = document.getElementById("detailMonthTitle");
        const grid = document.getElementById("monthDetailGrid");

        title.textContent = `${months[monthIndex]} ${currentYear}`;

        grid.innerHTML = "";

        daysOfWeek.forEach((day) => {
          const header = document.createElement("div");
          header.className = "day-header";
          header.textContent = day;
          grid.appendChild(header);
        });

        const firstDay = new Date(currentYear, monthIndex, 1).getDay();
        const daysInMonth = new Date(currentYear, monthIndex + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
          grid.appendChild(document.createElement("div"));
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const dateKey = `${currentYear}-${(monthIndex + 1)
            .toString()
            .padStart(2, "0")}-${day.toString().padStart(2, "0")}`;
          const dayDiv = document.createElement("div");
          dayDiv.className = "detail-day";

          const dayNumber = document.createElement("div");
          dayNumber.className = "detail-day-number";
          dayNumber.textContent = day;
          dayDiv.appendChild(dayNumber);

          if (activities[dateKey]) {
            const activitiesDiv = document.createElement("div");
            activitiesDiv.className = "detail-activities";

            activities[dateKey].forEach((activity) => {
              const actDiv = document.createElement("div");
              actDiv.className = "detail-activity";
              actDiv.style.background = activity.color;
              actDiv.textContent = activity.text;
              activitiesDiv.appendChild(actDiv);
            });

            dayDiv.appendChild(activitiesDiv);
          }

          dayDiv.onclick = () => openModal(dateKey);
          grid.appendChild(dayDiv);
        }

        overlay.style.display = "block";
      }

      function closeMonthDetail() {
        document.getElementById("monthDetailOverlay").style.display = "none";
        currentDetailMonth = null;
      }

      function showQuickAdd(e, dateKey) {
        const tooltip = document.getElementById("quickAdd");
        const activitiesList = activities[dateKey];

        if (activitiesList) {
          tooltip.innerHTML = activitiesList
            .map(
              (a) =>
                `<div style="background:${a.color};padding:4px 8px;margin:2px 0;border-radius:3px;font-size:0.75em;">${a.text}</div>`
            )
            .join("");
        } else {
          tooltip.textContent = "Click to add activity";
        }

        tooltip.style.display = "block";
        tooltip.style.left = e.pageX + 10 + "px";
        tooltip.style.top = e.pageY + 10 + "px";
      }

      function hideQuickAdd() {
        document.getElementById("quickAdd").style.display = "none";
      }

      function generateLegend() {
        const legendItems = document.getElementById("legendItems");
        legendItems.innerHTML = "";

        colorLabels.forEach((item, index) => {
          const legendItem = document.createElement("div");
          legendItem.className = "legend-item";

          const colorBox = document.createElement("div");
          colorBox.className = "color-box";
          colorBox.style.background = item.color;

          const labelInput = document.createElement("input");
          labelInput.type = "text";
          labelInput.className = "color-label";
          labelInput.value = item.label;
          labelInput.dataset.index = index;

          labelInput.addEventListener("input", (e) => {
            colorLabels[index].label = e.target.value || "Unlabeled";
            localStorage.setItem(
              "bigAssCalendarColorLabels",
              JSON.stringify(colorLabels)
            );
            generateColorPicker();
          });

          legendItem.appendChild(colorBox);
          legendItem.appendChild(labelInput);
          legendItems.appendChild(legendItem);
        });
      }

      function generateColorPicker() {
        const colorPicker = document.getElementById("colorPicker");
        colorPicker.innerHTML = "";

        colorLabels.forEach((item) => {
          const colorOption = document.createElement("div");
          colorOption.className = "color-option";
          colorOption.dataset.color = item.color;

          const colorBox = document.createElement("div");
          colorBox.className = "color-box";
          colorBox.style.background = item.color;

          const label = document.createElement("div");
          label.className = "color-option-label";
          label.textContent = item.label;

          colorOption.appendChild(colorBox);
          colorOption.appendChild(label);

          colorOption.onclick = () => {
            document
              .querySelectorAll(".color-option")
              .forEach((opt) => opt.classList.remove("selected"));
            colorOption.classList.add("selected");
            document.getElementById("selectedColor").value = item.color;
          };

          colorPicker.appendChild(colorOption);
        });

        if (colorPicker.children.length > 0) {
          colorPicker.children[0].classList.add("selected");
        }
      }

      function openModal(date) {
        currentEditingDate = date;
        document.getElementById("activityModal").style.display = "flex";
        document.getElementById("activityDate").value = formatDate(date);
        document.getElementById("activityText").value = "";

        generateColorPicker();
        loadActivityList(date);
      }

      function closeModal() {
        document.getElementById("activityModal").style.display = "none";
        currentEditingDate = null;
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      function saveActivity() {
        const text = document.getElementById("activityText").value.trim();
        const color = document.getElementById("selectedColor").value;

        if (!text) {
          alert("Please enter an activity");
          return;
        }

        if (!activities[currentEditingDate]) {
          activities[currentEditingDate] = [];
        }

        const colorLabel =
          colorLabels.find((item) => item.color === color)?.label || "Activity";

        activities[currentEditingDate].push({
          text: text,
          color: color,
          label: colorLabel,
          id: Date.now(),
        });

        saveYearData();

        document.getElementById("activityText").value = "";
        loadActivityList(currentEditingDate);
        generateCalendar();

        if (currentDetailMonth !== null) {
          openMonthDetail(currentDetailMonth);
        }
      }

      function loadActivityList(date) {
        const listDiv = document.getElementById("activityList");
        listDiv.innerHTML = "";

        if (activities[date]) {
          activities[date].forEach((activity) => {
            const item = document.createElement("div");
            item.className = "activity-item";
            item.style.background = activity.color + "20";
            item.innerHTML = `
                        <span><strong>${activity.label}:</strong> ${activity.text}</span>
                        <button class="delete-btn" onclick="deleteActivity('${date}', ${activity.id})">Ã—</button>
                    `;
            listDiv.appendChild(item);
          });
        }
      }

      function deleteActivity(date, id) {
        if (confirm("Delete this activity?")) {
          activities[date] = activities[date].filter((a) => a.id !== id);
          if (activities[date].length === 0) {
            delete activities[date];
          }
          saveYearData();
          loadActivityList(date);
          generateCalendar();

          if (currentDetailMonth !== null) {
            openMonthDetail(currentDetailMonth);
          }
        }
      }

      function clearAllActivities() {
        if (
          confirm(
            "Are you sure you want to clear ALL activities? This cannot be undone."
          )
        ) {
          activities = {};
          saveYearData();
          generateCalendar();
          if (currentDetailMonth !== null) {
            openMonthDetail(currentDetailMonth);
          }
        }
      }

      function resetColorLabels() {
        if (confirm("Reset color labels to defaults?")) {
          colorLabels = [...defaultColors];
          localStorage.setItem(
            "bigAssCalendarColorLabels",
            JSON.stringify(colorLabels)
          );
          generateLegend();
          generateColorPicker();
        }
      }

      async function exportAsImage() {
        const button = event.target;
        button.textContent = "Generating...";
        button.disabled = true;

        try {
          const element =
            currentDetailMonth !== null
              ? document.getElementById("monthDetailGrid")
              : document.getElementById("calendar");
          const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff",
          });

          const link = document.createElement("a");
          link.download =
            currentDetailMonth !== null
              ? `big-ass-calendar-${months[
                  currentDetailMonth
                ].toLowerCase()}-${currentYear}.png`
              : `big-ass-calendar-${currentYear}.png`;
          link.href = canvas.toDataURL();
          link.click();
        } catch (error) {
          alert("Error generating image. Please try again.");
        } finally {
          button.textContent = "Save as Image";
          button.disabled = false;
        }
      }

      async function exportAsPDF() {
        const button = event.target;
        button.textContent = "Generating...";
        button.disabled = true;

        try {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("l", "mm", "a4");

          const element =
            currentDetailMonth !== null
              ? document.getElementById("monthDetailGrid")
              : document.getElementById("calendar");
          const canvas = await html2canvas(element, {
            scale: 1,
            useCORS: true,
            backgroundColor: "#ffffff",
          });

          const imgData = canvas.toDataURL("image/png");
          const imgWidth = 280;
          const pageHeight = 200;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight;
          let position = 10;

          pdf.addImage(imgData, "PNG", 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          while (heightLeft >= 0) {
            position = heightLeft - imgHeight + 10;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          pdf.save(
            currentDetailMonth !== null
              ? `big-ass-calendar-${months[
                  currentDetailMonth
                ].toLowerCase()}-${currentYear}.pdf`
              : `big-ass-calendar-${currentYear}.pdf`
          );
        } catch (error) {
          alert("Error generating PDF. Please try again.");
        } finally {
          button.textContent = "Save as PDF";
          button.disabled = false;
        }
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeModal();
          closeMonthDetail();
        }
        if (e.key === "h" || e.key === "H") {
          toggleHeader();
        }
        if (e.key === "l" || e.key === "L") {
          toggleLegend();
        }
      });

      // Initialize
      function init() {
        // Set the year selector to current year
        const yearSelector = document.getElementById("yearSelector");
        yearSelector.value = currentYear;

        // Load data for current year
        loadYearData();

        // Generate everything
        generateLegend();
        generateColorPicker();
        generateCalendar();
        applySavedStates();
      }

      init();
    </script>
  </body>
</html>
